package com.example.postifyapp

import android.Manifest
import android.app.Activity
import android.app.Instrumentation
import android.content.Intent
import android.net.Uri
import android.os.Build
import androidx.compose.ui.test.*
import androidx.compose.ui.test.performTextReplacement
import androidx.compose.ui.test.junit4.createAndroidComposeRule
import androidx.test.espresso.intent.Intents
import androidx.test.espresso.intent.Intents.intending
import androidx.test.espresso.intent.matcher.IntentMatchers.hasAction
import androidx.test.ext.junit.runners.AndroidJUnit4
import androidx.test.rule.GrantPermissionRule
import com.example.postifyapp.view.PostCardActivity
import org.junit.After
import org.junit.Before
import org.junit.Rule
import org.junit.Test
import org.junit.runner.RunWith

@RunWith(AndroidJUnit4::class)
class PostInstrumentedTest {

    @get:Rule
    val composeRule = createAndroidComposeRule<PostCardActivity>()

    /**
     * This rule automatically clicks "Allow" on the system permission dialogs.
     * We include both legacy and modern (API 33+) media permissions.
     */
    @get:Rule
    val permissionRule: GrantPermissionRule = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
        // Android 13+ (API 33+) only needs this for images
        GrantPermissionRule.grant(Manifest.permission.READ_MEDIA_IMAGES)
    } else if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
        // Android 11 & 12 (API 30-32)
        GrantPermissionRule.grant(Manifest.permission.READ_EXTERNAL_STORAGE)
    } else {
        // Android 10 and below
        GrantPermissionRule.grant(
            Manifest.permission.READ_EXTERNAL_STORAGE,
            Manifest.permission.WRITE_EXTERNAL_STORAGE
        )
    }

    @Before
    fun setup() {
        Intents.init()
    }

    @After
    fun tearDown() {
        Intents.release()
    }

    @Test
    fun testCreatePostFlow() {
        // 1. Prepare a fake image URI result
        val resultData = Intent().apply {
            data = Uri.parse("content://media/external/images/media/1")
        }
        val result = Instrumentation.ActivityResult(Activity.RESULT_OK, resultData)

        // 2. Stub the Gallery Intent
        intending(hasAction(Intent.ACTION_GET_CONTENT)).respondWith(result)
        intending(hasAction(Intent.ACTION_PICK)).respondWith(result)
        intending(hasAction("android.provider.action.PICK_IMAGES")).respondWith(result)

        // 3. Interact with the UI - FIXED FUNCTION NAMES BELOW
        composeRule.onNodeWithText("Post Title")
            .performTextReplacement("Android Testing")

        composeRule.onNodeWithText("Post Snippet")
            .performTextReplacement("This snippet was generated by an automated test.")

        // 4. Click the image selector
        composeRule.onNodeWithText("Tap to select image")
            .performClick()

        // 5. Finalize the post
        composeRule.onNodeWithText("Publish Post")
            .performClick()
    }
}